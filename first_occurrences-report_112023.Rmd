---
title: 'UKB CVD: Phase 1 & Phase 2 First Occurrences Analysis, Baseline Characteristics
  and Initial Metabolite Exploration'
output:
  html_document:
    df_print: paged
    toc: TRUE
    toc_float: TRUE
    number_sections: TRUE
date: "2023-11-22"
classoption: landscape
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(dplyr)
library(tidyr)
library(gtsummary)
library(stringr)
library(purrr)
library(broom)
library(gt)

source("labellist.R")
theme_gtsummary_compact()
```

Author: M Janiczek
Prepared for: R Balasubramanian & K Rexrode 

## Updates

Since last report, changed definition of Type 2 diabetes to only include ICD10 Code E11. Moved other diabetes codes into a new variable "Diabetes Other". Also added Model 1 results and forest plots.

# Summary

We gained access to download the UKBiobank Phase 1 NMR Metabolomics data on April 27, in addition to having access to the full cohort of UKBiobank data. Phase 2 NMR Metabolomics data was released in July 2020 and we gained access to download on July 19. In this report I summarize the baseline characteristics in the full UKB sample (N = 502,411) as well as the subjects with available metabolomics measurements from their first UKB assessment centre visit from Phase I (N = 118,004) and Phase 2 (N = 156,375). 

I also downloaded the aggregate "First Occurrences" data to determine if we should use that field for our outcome estimate. 

# Methods

I summarized the number and percent of total for categorical variables such as smoking status, hysterectomy, menopause, and hormone replacement therapy (HRT) status. I calculated mean and interquartile range (IQR) of several continuous measurements taken at first assessment visit. Field code is included in the table in case definitions are needed for clarity. 

By matching ICD10 codes (as described in the Said 2018 paper) in field 41270 (Hospital Inpatient records), as well as First Occurrences data (category 1712), I identified incident diagnosis of Hypertension, Type 2 Diabetes, Atrial Fibrilation, Stroke, and Coronary Artery Disease (CAD). I used the corresponding date of diagnoses and compared it to date of initial assessment (field 53) to identify diagnoses that occurred after first assessment. Some subjects had more than one condition, and all distnict diagnoses are included. In cases where a subject had multiple dates for the same diagnosis I used the first diagnosis date to compare to initial assessment at UKB assessment center. 

I made a categorical variable "Metabolite Status" based on if subjects were included in the Phase I or Phase II metabolite release. 

# First occurrences data

First occurrences data (category 1712) were downloaded using Category 2409 "Circulatory system disorders" as well as category 2404 "Endocrine, nutritional and metabolic diseases" (for diabetes). 
The data fields included date the code was first recorded across primary care data, hospital inpatient data, death register records, or self-reported medical conditions reported at baseline or subsequent UK Biobank assessment centre visit, as well as the source of the code. 

After downloading the data, I searched for fields containing the ICD10 codes previously discussed (from the Said 2018 paper), and created new variables for the 5 conditions, indicating "1" for patients who had that code AFTER the date of first UKB assessment, and 0 otherwise. 

The following ICD10 codes were used to identify outcomes of interest (based on Appendix of Said 2018 paper):

```{r}
disease_def <- data.frame(
  disease = c("Coronary Artery Disease", 
              "Atrial Fibrillation",
              "Stroke",
              "Hypertension",
              "Diabetes Mellitus Type 2"),
  `Available-in-Hospital_Records`= c("I21-25, Z951, Z955", "I48", "I60, I61, I629, I63, I64, I678, I690, I693, G951, H341, H342, S066", "I10-I13, I15, O10", "E10-E14"),
  `Available-in-First_Occurrences` = c("I21-I25", "I48", "I60, I61, I63, I64", "I10-I13, I15", "E10-E14" )
)

gt::gt(disease_def)
```


We determined we would go with only the first occurrences data for now as it appears to be cleaner. 


# Results

Below we can see the distribution of these codes from the various sources, which are largely still from hospital inpatient records:

```{r}
load("/rawdata/UKBB/Metabolomics_jul2023/first_occ_all_long.Rdata")

load("/rawdata/UKBB/Metabolomics_jul2023/dat_subset_metab_112223.Rdata")

# load prepared ukb keys
ukb_key_metab <- ukbtools::ukb_df_field("ukb673788", path = "/rawdata/UKBB/Metabolomics_jul2023")
library(ggplot2)
final_fo %>%
  filter(has_disease_fo == 1) %>%
  ggplot(aes(disease_fo)) +
  geom_bar(aes(fill = source_of_report)) +
  theme_bw() +
  ylab("N incident cases") +
  xlab("Disease") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

#length(unique(final_fo$eid))




```


First, we can examine the distribution of incidence of our conditions of interest in the overall cohort compared to those in the PHase 1 cohort, split by Sex. The incidence is calculated using the first occurrences data (denoted with "FO" below).

```{r}
# tab_disease <- dat_sub_metab2 %>%
#   select(sex_f31_0_0, metabolite_status, 
#          #all_of(names(unlist(outcomedatlist))), all_of(names(unlist(outcomedatlist_fo))),
#          cad, cad_fo, afib, afib_fo, stroke, stroke_fo, hypertension, hypertension_fo, diabetes_t2, diabetes_t2_fo
#          )

# now reducing it to just be first occurences 
tab_disease <- dat_sub_metab2 %>%
  select(sex_f31_0_0, metabolite_status, 
         #all_of(names(unlist(outcomedatlist))), all_of(names(unlist(outcomedatlist_fo))),
         cad_fo, afib_fo,stroke_fo, hypertension_fo, diabetes_t2_fo
         )

metab_tab_phase1_sex <- tab_disease %>%
  filter(metabolite_status == "Phase 1") %>%
  select(-metabolite_status) %>%
  tbl_summary(by = sex_f31_0_0, missing = "no") %>%
  bold_labels() %>%
  #add_n() %>%
  add_overall()


metab_tab_phase2_sex <- tab_disease %>%
  filter(metabolite_status == "Phase 2") %>%
  select(-metabolite_status) %>%
  tbl_summary(by = sex_f31_0_0, missing = "no") %>%
  bold_labels() %>%
  add_overall()

all_tab_phase1_outcome <- tab_disease %>%
  select(-metabolite_status) %>%
  tbl_summary(by = sex_f31_0_0, missing = "no") %>%
  bold_labels() %>%
  #add_n() %>%
  add_overall()

tbl_merge_outcome <- tbl_merge(tbls = list(all_tab_phase1_outcome, metab_tab_phase1_sex, metab_tab_phase2_sex),
                               tab_spanner = c("**All Samples**", "**Phase 1 Samples**", "**Phase 2 Samples**"))

tbl_merge_outcome

```



# Summary of baseline characteristics

```{r}
load(here::here("testtab2_080123.Rdata"))
```

The below table describes the distribution of various baseline characteristics and measurements, defined as measured at the first date of assessment. 

```{r}
tbl_merge1
```

For the models, we stratify by age in the following strata <50, 50-59, 60-69, 70-85. See below for distribution of participants by phase, sex, and age category.

```{r}
# table for age strata and sex 

tabdat_age <- dat_sub_metab2 %>%
  select(age_cat, sex_f31_0_0, metabolite_status)

age_tab_phase1_sex <- tabdat_age %>%
  filter(metabolite_status == "Phase 1") %>%
  select(-metabolite_status) %>%
  tbl_summary(by = sex_f31_0_0, missing = "no") %>%
  bold_labels() %>%
  #add_n() %>%
  add_overall()


age_tab_phase2_sex <- tabdat_age %>%
  filter(metabolite_status == "Phase 2") %>%
  select(-metabolite_status) %>%
  tbl_summary(by = sex_f31_0_0, missing = "no") %>%
  bold_labels() %>%
  add_overall()

all_tab_age <- tabdat_age %>%
  select(-metabolite_status) %>%
  tbl_summary(by = sex_f31_0_0, missing = "no") %>%
  bold_labels() %>%
  #add_n() %>%
  add_overall()

tbl_merge_age <- tbl_merge(tbls = list(all_tab_age, age_tab_phase1_sex, age_tab_phase2_sex),
                               tab_spanner = c("**All Samples**", "**Phase 1 Samples**", "**Phase 2 Samples**"))

tbl_merge_age
```

# Initial Metabolite exploration

All 249 metabolites had some sort of measurement (>0) 99.9% of the Phase I samples. I used the updated Phase I data released with Phase II.

## M1 (Minimal Model): Age Stratified + Menopause

Outcome: Metabolite level
Exposure: Sex

Age split into following strata: <50, 50-59, 60-69, 70-85. Linear regression model of for each metabolite fit within each strata. Centered and scaled metabolite value so that we could compare coefficients easier. 

$CenteredScaled Metabolite Value \sim Sex + Menopause*$


* Menopausal status: "Not sure" but over 55 goes into "Menopausal". Under 55 go into category "Undetermined". Variable only used in the <50 and 50-59 strata.

Within each age strata, fit the M1 for all metabolites and get p-values for exposure. Do FDR adjustment for multiple testing; use q <0.05. 

```{r}

# get the data we want to analyze

dat_sub_metab2 <- dat_sub_metab2 %>%
  #filter(metabolite_status == "Phase 1") %>%
  # make age category
  mutate(age_cat = ifelse(
    age_when_attended_assessment_centre_f21003_0_0 <50, "<50",
    ifelse(age_when_attended_assessment_centre_f21003_0_0 >=50 & 
             age_when_attended_assessment_centre_f21003_0_0 <60, "50-59",
      ifelse(age_when_attended_assessment_centre_f21003_0_0 >=60 & 
             age_when_attended_assessment_centre_f21003_0_0 <70, "60-69",
             ifelse(age_when_attended_assessment_centre_f21003_0_0 >=70, "70-85", NA)))),
    menopause_cat = ifelse(
      age_when_attended_assessment_centre_f21003_0_0 <55 & 
        had_menopause_f2724_0_0 %in% c("Prefer not to answer", "Not sure - other reason", "Not sure - had a hysterectomy"), "Undetermined",
      ifelse(age_when_attended_assessment_centre_f21003_0_0 >=55 & 
        had_menopause_f2724_0_0 %in% c("Prefer not to answer", "Not sure - other reason", "Not sure - had a hysterectomy"), "Yes",
      ifelse(sex_f31_0_0 == "Male", "No",
      had_menopause_f2724_0_0))))

metab_key2 <- ukb_key_metab %>%
  filter(!str_detect(col.name, "qc_flag"))%>%
  filter(field.showcase %in% 23400:24000) %>%
  filter(col.type == "Continuous") %>%
  filter(str_detect(field.tab, ".0.0"))

dat_phase1 <- dat_sub_metab2 %>%
  filter(metabolite_status == "Phase 1") %>%
  # doing center scaling so we can compare estimates?
  mutate(across(
    all_of(metab_key2$col.name),scale)
  )

# I don't think we need to do this log transformation??
met1 <- dat_phase1 %>%
  select(all_of(metab_key2$col.name))# %>%
 # transmute_all(~scale(log(. +.01), center = FALSE))

# should I go to long format??

met_long <- dat_phase1 %>%
  dplyr::select(eid, age_cat, menopause_cat, sex = sex_f31_0_0, all_of(metab_key2$col.name)) %>%
  pivot_longer(-c(eid, age_cat, menopause_cat, sex), names_to = "metabolite", values_to = "value")


long_test_1 <- met_long %>%
  filter(age_cat %in% c("<50", "50-59")) %>%
  nest(.by = c(age_cat, metabolite)) %>%
  mutate(model = map(data, ~lm(value ~ sex + menopause_cat, data = .x))) %>%
        mutate(tidied = map(model, ~tidy(.x, conf.int = T))) 

res_lt50_to_59 <- long_test_1 %>% select(metabolite, age_cat, tidied) %>%
  unnest(tidied) %>%
  filter(term == "sex.L")

long_test_2 <- met_long %>%
  filter(age_cat %in% c("60-69", "70-85")) %>%
  nest(.by = c(age_cat, metabolite)) %>%
  mutate(model = map(data, ~lm(value ~ sex, data = .x))) %>%
        mutate(tidied = map(model, ~tidy(.x, conf.int = T))) 

res_60_to_85 <- long_test_2 %>% select(metabolite, age_cat, tidied) %>%
  unnest(tidied) %>%
  filter(term == "sex.L")

all_strat_M1 <- bind_rows(res_lt50_to_59, res_60_to_85) %>%
  mutate(fdr = p.adjust(p.value, "fdr"),
         phase = "Phase I",
         met_threshold = fdr < 0.05 & abs(estimate)>0.5) 


subset_M1 <- all_strat_M1 %>%
  filter(fdr < 0.05 & abs(estimate)>.5) %>%
  mutate(phase = "Phase I") # what would be a "meaningful" estimate?

#length(unique(subset_M1$metabolite))
#unique(subset_M1$age_cat)


gt::gt(subset_M1)%>%
  tab_header(title = "Phase I Metabolites q <0.05 and abs(estimate)>0.5")
#write.csv(test28, "lm_metabolites_051523.csv")
```

```{r}
# now try to visualize densities for some of those top metabolites


library(ggridges)
dat_select <- met_long %>%
  filter(metabolite %in% (subset_M1 %>% filter(age_cat == "60-69") %>% pull(metabolite))) %>%
  filter(age_cat == "60-69") #%>%
  #mutate(metabolite = str_extract(metabolite, "^.{40}"))

test <- subset_M1 %>% filter(age_cat == "60-69")

ggplot(
  dat_select,
  aes(y = metabolite, x = value)) +
  geom_density_ridges(aes(fill = sex), alpha = 0.6) +
  theme(axis.text.y = element_blank(),#element_text(size = 3),
        legend.position = "bottom")+
  xlim(-2.5, 2.5) +
  ggtitle("Age 60-69 M vs F standardized metabolite values", subtitle = "For mx with p.adj <0.5 and abs(est)>0.5")
#TODO make ylim labels smaller and 
#TODO move key to bottom
  
  
  #geom_text(aes(y = metabolite, x = 0, label = str_extract(metabolite, "^.{40}")),size = 1)

dat_select2 <- met_long %>%
  filter(metabolite %in% (subset_M1 %>% filter(age_cat == "70-85") %>% pull(metabolite))) %>%
  filter(age_cat == "70-85") #%>%
  #mutate(metabolite = str_extract(metabolite, "^.{40}"))


ggplot(
  dat_select2,
  aes(y = metabolite, x = value)) +
  geom_density_ridges(aes(fill = sex), alpha = 0.6) +
  theme(axis.text.y = element_blank(),#element_text(size = 3),
        legend.position = "bottom")+
  xlim(-2.5, 2.5) +
  ggtitle("Age 70-85 M vs F standardized metabolite values", subtitle = "For mx with p.adj <0.5 and abs(est)>0.5")

```

## Phase II M1

```{r}
dat_phase2 <- dat_sub_metab2 %>%
  filter(metabolite_status == "Phase 2") %>%
  # doing center scaling so we can compare estimates?
  mutate(across(
    all_of(metab_key2$col.name),scale)
  )

met_long2 <- dat_phase2 %>%
  dplyr::select(eid, age_cat, menopause_cat, sex = sex_f31_0_0, all_of(metab_key2$col.name)) %>%
  pivot_longer(-c(eid, age_cat, menopause_cat, sex), names_to = "metabolite", values_to = "value")


long_test_phase2 <- met_long2 %>%
  filter(age_cat %in% c("<50", "50-59")) %>%
  nest(.by = c(age_cat, metabolite)) %>%
  mutate(model = map(data, ~lm(value ~ sex + menopause_cat, data = .x))) %>%
        mutate(tidied = map(model, tidy)) 

res_lt50_to_59_p2 <- long_test_phase2 %>% select(metabolite, age_cat, tidied) %>%
  unnest(tidied) %>%
  filter(term == "sex.L")

long_test_2_phase2 <- met_long2 %>%
  filter(age_cat %in% c("60-69", "70-85")) %>%
  nest(.by = c(age_cat, metabolite)) %>%
  mutate(model = map(data, ~lm(value ~ sex, data = .x))) %>%
        mutate(tidied = map(model, tidy)) 

res_60_to_85_p2 <- long_test_2_phase2 %>% select(metabolite, age_cat, tidied) %>%
  unnest(tidied) %>%
  filter(term == "sex.L")

all_strat_M1_p2 <- bind_rows(res_lt50_to_59_p2, res_60_to_85_p2) %>%
    mutate(fdr = p.adjust(p.value, "fdr"),
         phase = "Phase II",
         met_threshold_p2 = fdr < 0.05 & abs(estimate)>0.5) 


subset_M1_p2 <- all_strat_M1_p2 %>%
  filter(fdr < 0.05, abs(estimate) >0.5) %>%
  mutate(phase = "Phase II")

length(unique(subset_M1_p2$metabolite))
unique(subset_M1_p2$age_cat)
```


```{r eval=FALSE}
# now try to visualize densities for some of those top metabolites
library(ggridges)
dat_select_p2 <- met_long2 %>%
  filter(metabolite %in% (subset_M1_p2 %>% filter(age_cat == "<50") %>% pull(metabolite))) %>%
  filter(age_cat == "<50") #%>%
  #mutate(metabolite = str_extract(metabolite, "^.{40}"))

ggplot(
  dat_select_p2,
  aes(y = metabolite, x = value)) +
  geom_density_ridges(aes(fill = sex), alpha = 0.6) +
  theme(axis.text.y = element_blank(),#element_text(size = 3),
        legend.position = "bottom")+
  xlim(-2.5, 2.5) +
  ggtitle("Phase II Age 60-69 M vs F standardized metabolite values", subtitle = "For mx with p.adj <0.5 and abs(est)>0.5")
#TODO make ylim labels smaller and 
#TODO move key to bottom
  
  
  #geom_text(aes(y = metabolite, x = 0, label = str_extract(metabolite, "^.{40}")),size = 1)

dat_select2_p2 <- met_long2 %>%
  filter(metabolite %in% (subset_M1_p2 %>% filter(age_cat == "70-85") %>% pull(metabolite))) %>%
  filter(age_cat == "70-85") #%>%
  #mutate(metabolite = str_extract(metabolite, "^.{40}"))


ggplot(
  dat_select2_p2,
  aes(y = metabolite, x = value)) +
  geom_density_ridges(aes(fill = sex), alpha = 0.6) +
  theme(axis.text.y = element_blank(),#element_text(size = 3),
        legend.position = "bottom")+
  xlim(-2.5, 2.5) +
  ggtitle("Phase II Age 70-85 M vs F standardized metabolite values", subtitle = "For mx with p.adj <0.5 and abs(est)>0.5")

```

## Summarizing M1 Results

Below I summarize which of the metabolites in Phase I which met the threshold of having BOTH FDR-adjusted pvalue < 0.05 AND an absolute value estimate in the model of >0.5 also met the same threshold criteria in Phase II data. 

```{r}


all_strat_both_phases_wide <- left_join(
  all_strat_M1 %>% select(metabolite, age_cat, met_threshold, fdr),
  all_strat_M1_p2 %>% select(metabolite, age_cat, met_threshold_p2)) %>%
  mutate(sig_category = ifelse(
    met_threshold == FALSE & met_threshold_p2 == FALSE, "Didn't meet threshold",
    ifelse( met_threshold == TRUE & met_threshold_p2 == FALSE, "Met threshold, not validated",
            ifelse(
              met_threshold == TRUE & met_threshold_p2 == TRUE, "Validated in Phase 2", "Didn't meet threshold"
            ))
  ))

res_M1 <- all_strat_M1 %>%
  left_join(all_strat_both_phases_wide %>% select(metabolite, age_cat, sig_category))

# combine p1 and p2 full data
all_strat_both_phases_long <- bind_rows(res_M1, all_strat_M1_p2) %>%
  select(metabolite, age_cat, phase, sig_category, estimate, fdr, met_threshold_p1 = met_threshold, met_threshold_p2)

save(all_strat_both_phases_long, file = "results_mod1_bothphases.Rdata")

write.csv(all_strat_both_phases_long, file = "results_mod1_bothphases.csv")

# volcano plot
ggplot(res_M1, aes(x = estimate, y = -log10(fdr+1), color = sig_category, alpha = 0.1)) +
  geom_point() +
  scale_color_manual(values = c("gray", "black", "blue"), name = "")+
  facet_wrap(~age_cat) +
  guides(alpha = FALSE) +
  geom_hline(yintercept = -log10(1.05), linetype = "dashed", color = "red") +
  xlab("Model 1 Sex Coefficient from Phase I") +
  theme_bw() +
  theme(legend.position = "bottom")
#ggsave("m1_volcano.png", height = 4, width = 6)

# TODO get unique metabolites in each strata that met validation threshold

res_M1 %>%
  tbl_cross(row = age_cat, col = sig_category)


original_sig_mets <- res_M1 %>%
  filter(met_threshold == TRUE)

validated_mets <- res_M1 %>%
  filter(sig_category == "Validated in Phase 2")
```

number of unique metabolites that met the threshold in Phase I 

```{r}
length(unique(original_sig_mets$metabolite))
```

 number of unique validated metabolites where the metabolite met the thresholds in both phase 1 and phase 2. Saved table of these 81 unique metabolites and their metabolite group and subgroup (validated_unique_mets_81_details.csv). 
 
```{r}
length(unique(validated_mets$metabolite))


#validated_mets_details <- validated_mets %>% select(metabolite) %>%
#  group_by(metabolite) %>%
#  slice(1)%>%
#  ungroup() %>%
#  left_join(ukb_key_metab %>% select(metabolite = col.name, title, units, Group, Subgroup))

#write.csv(validated_mets_details, file = "validated_unique_mets_81_details.csv")
```



## Forest plots 

Group metabolites into classes, then create forest plot per metabolite class. 
Plotting lipoprotein subclasses separately since there were 11 subclasses for that metabolite group. 

Bars denote effect size in direction for metabolites from M1 that had FDR <0.05. (Bar is 0 if FDR >0.05). 

### Forest plots by metabolite group (excluding Lipoproteins)

```{r}
met_groups <- read.table("/rawdata/UKBB/Metabolomics_jul2023/Nightingale_biomarker_groups.txt", header = TRUE, fill = T, sep = "\t") %>%
  mutate(field.showcase = as.character(field_id))

ukb_key_metab <- ukb_key_metab %>%
  left_join(met_groups)

subset_M1_forest <- subset_M1 %>%
  left_join(ukb_key_metab %>% select(metabolite = col.name, Group, Subgroup)) %>%
  mutate(metabolite2 = str_remove(metabolite, pattern = "\\_f.*"))

subset_M1_forest_p2 <- subset_M1_p2 %>%
  left_join(ukb_key_metab %>% select(metabolite = col.name, Group, Subgroup)) %>%
  mutate(metabolite2 = str_remove(metabolite, pattern = "\\_f.*"))

subset_overall <- bind_rows(subset_M1_forest, subset_M1_forest_p2) %>%
  mutate(age_cat = as.factor(age_cat))

unique(subset_M1_forest$Group)

summary(as.factor(subset_M1_forest$Group))

age_cats <- data.frame(age_cat = c("<50", "50-59", "60-69", "70-85"),
                       default_val = 0)


# ggplot(subset_M1_forest,
#        aes(x = metabolite, y = estimate, ymin = conf.low, 
#            ymax = conf.high,
#            col = age_cat, fill = age_cat)) +
#   geom_hline(yintercept = 0, lty = 2) +
#   geom_linerange(size = 5, position = position_dodge(width = 0.5)) +
#   geom_point(size = 3, shape = 21, colour = "white", stroke = 0.5, 
#              position = position_dodge(width = 0.5)) +
#   coord_flip() +
#   theme_minimal()

```



```{r eval = FALSE}
phospho <- subset_overall %>%
  filter(Group == "Phospholipids") %>%
  #group_by(metabolite) %>%
  arrange(estimate) %>%
  #ungroup() %>%
  #left_join(age_cats) %>%
  complete(nesting(metabolite2), age_cat, phase,
           fill = list(estimate = 0)) #%>%
  #arrange(estimate) %>%
  #group_by(metabolite) %>%
  #arrange(estimate)
  

ggplot(phospho,
       aes(x = metabolite2, y = estimate, col = age_cat, fill = age_cat)) +
  geom_col(position = "dodge") +
  coord_flip() +
  theme_minimal() +
  theme() +
  ggtitle("Phospholipids") +
  facet_grid(~phase)
```

```{r}
# trying loop to get plot for all the subgroups

subset_nonlipo <- subset_overall %>%
  filter(Group != "Lipoprotein subclasses" & !is.na(Group))

met_cats <- unique(subset_nonlipo$Group)

map_res <- data.frame(
  met_cats = met_cats) %>%
  mutate(data = map(met_cats, ~ subset_nonlipo %>% filter(Group == .x) %>%
                      arrange(estimate) %>%
                      complete(nesting(metabolite2), age_cat, phase,
                               fill = list(estimate = 0))))

map2(.x = map_res$data, .y = met_cats, 
                        ~ggplot(.x,
       aes(x = metabolite2, y = estimate, col = age_cat, fill = age_cat)) +
        geom_col(position = "dodge") +
        coord_flip() +
        theme_minimal() +
        theme() +
        ggtitle(.y) +
        facet_grid(~phase))
```

### Forest Plots For Lipoprotein subclasses

There were 14 unique Lipoprotein subclasses within the dataset. 11 of them had significant metabolites from M1 and I plot these separately below. 

```{r}

subset_lipo <- subset_overall %>%
  filter(Group == "Lipoprotein subclasses")

lipo_cats <- unique(subset_lipo$Subgroup)

map_res_lipo <- data.frame(
  lipo_cats = unique(subset_lipo$Subgroup)) %>%
  mutate(data = map(lipo_cats, ~ subset_lipo %>% filter(Subgroup == .x) %>%
                      arrange(estimate) %>%
                      complete(nesting(metabolite2), age_cat, phase,
                               fill = list(estimate = 0))))

map2(.x = map_res_lipo$data, .y = lipo_cats, 
                        ~ggplot(.x,
       aes(x = metabolite2, y = estimate, col = age_cat, fill = age_cat)) +
        geom_col(position = "dodge") +
        coord_flip() +
        theme_minimal() +
        theme() +
        ggtitle(.y) +
        facet_grid(~phase))
```






## M2 Adjusted model

Adjust for: 

* Smoking status 
* Race (group into white (including british and irish), black, asian, southeast asian, mixed/other)
* BMI

Within each age strata, fit the M2 for all metabolites and get p-values for exposure. Do q-value adjustment, use q <0.05. 

# Validation 

In Phase II data, do same agnostic analysis. How many metabolites are concordant? 

* Within each strata, choose metabolites that had q-value <0.05 in Phase I. Look at those metabolites in the Phase II data- run model. 

* There will be different sets of metabolites for each strata. 

* There will be two sets of validated findings (from M1 and M2). 

* Look at magnitude of difference and direction (visualization).



# References

Said MA, Verweij N, van der Harst P. Associations of Combined Genetic and Lifestyle Risks with Incident Cardiovascular Disease and Diabetes in the UK Biobank Study. JAMA Cardiol. 2018;3(8):693-702.
